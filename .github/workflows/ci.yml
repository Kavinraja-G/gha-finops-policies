name: CI

on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main

permissions:
  contents: read

env:
  CONFTEST_VERSION: 0.49.1
  WORKING_DIR: ./

jobs:
  test-action:
    name: GitHub Actions Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        id: checkout
        uses: actions/checkout@v4

      - name: Install Conftest
        run: |
          wget -O - 'https://github.com/open-policy-agent/conftest/releases/download/v${{ env.CONFTEST_VERSION }}/conftest_${{ env.CONFTEST_VERSION }}_Linux_x86_64.tar.gz' | tar zxvf -
          ./conftest --version

      - name: Test Local Action
        id: test-action
        uses: ./
        with:
          config: |
            ec2:
              enabled: false
              allowedInstanceTypeRegEx: "large|metal"
            tags:
              enabled: true
              allowedBillingTags:
                - "ApplicationOwner"
                - "FinancialOwner"
                - "createdBy"

      - name: Print Generated Config
        id: output
        run: cat "${{ steps.test-action.outputs.out-file }}"

      - name: Run Conftest
        id: conftest
        run:
          ./conftest test ${{ env.WORKING_DIR }}test-tfplan.json -d ${{
          steps.test-action.outputs.out-file }}
